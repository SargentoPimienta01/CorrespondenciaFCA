---
import Layout from '../../layouts/Correspondencia.astro';

// Obtener el ID del documento desde los parámetros de la URL
const { id } = Astro.params;
console.log('ID obtenido de los parámetros:', id); // Verificar el ID

let token = null;
let documento = null;

// Intentar obtener el token desde las cookies (establecido por el cliente)
token = Astro.cookies.get('token');
console.log('Token antes de enviar:', token, typeof token); // Verificar si el token está presente

if (token && typeof token === 'object') {
  token = token.value;  // Extrae el valor del token
}

console.log('Token extraído:', token);

if (!token) {
  console.error('No se ha encontrado un token de autenticación en las cookies.');
} else {
  try {
    // Realizar la solicitud GET con el token
    const response = await fetch(`http://localhost:5064/api/documentos/${id}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    console.log('Token formateado:', token);
    console.log('Id Obtenido:', id);
    console.log('Respuesta', response.headers);
    console.log('Estado de la respuesta:', response.status); // Verificar el estado de la respuesta

    if (!response.ok) {
      const errorData = await response.json();
      console.error('Error recibido de la API:', errorData); // Verificar los errores recibidos
      throw new Error('Error al obtener el documento desde la API');
    }

    const result = await response.json();
    documento = result.data.documento; // Aquí extraemos el documento del objeto `data`
    console.log('Documento obtenido:', documento); // Verificar los datos del documento obtenidos

  } catch (error) {
    console.error('Hubo un problema al obtener los datos del documento:', error);
  }
}
---

<Layout title={`Detalles del Documento ${documento?.codigoDoc ?? ''}`}>
  <main class="p-5">
    {documento ? (
      <div>
        <h1 class="text-2xl font-bold mb-5">Detalles del Documento: {documento.codigoDoc}</h1>

        <div class="grid grid-cols-2 gap-5">
          <div class="col-span-2 sm:col-span-1">
            <label class="block text-sm font-medium text-gray-700">ID del Documento</label>
            <div class="mt-1 p-2 border border-gray-300 rounded-md">{documento.codigoDoc}</div>
          </div>

          <div class="col-span-2 sm:col-span-1">
            <label class="block text-sm font-medium text-gray-700">Fecha de Recepción FCA</label>
            <div class="mt-1 p-2 border border-gray-300 rounded-md">{new Date(documento.fechaRecepcionFca).toLocaleString()}</div>
          </div>

          <div class="col-span-2 sm:col-span-1">
            <label class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
            <div class="mt-1 p-2 border border-gray-300 rounded-md">{new Date(documento.fechaEntrega).toLocaleString()}</div>
          </div>

          <div class="col-span-2 sm:col-span-1">
            <label class="block text-sm font-medium text-gray-700">Fecha Plazo</label>
            <div class="mt-1 p-2 border border-gray-300 rounded-md">{new Date(documento.fechaPlazo).toLocaleString()}</div>
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700">Asunto</label>
            <div class="mt-1 p-2 border border-gray-300 rounded-md">{documento.asuntoDoc}</div>
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700">Observaciones</label>
            <div class="mt-1 p-2 border border-gray-300 rounded-md">{documento.observaciones}</div>
          </div>

          <div class="col-span-2 sm:col-span-1">
            <label class="block text-sm font-medium text-gray-700">Tipo de Documento</label>
            <div class="mt-1 p-2 border border-gray-300 rounded-md">{documento.tipoDocumento}</div>
          </div>

          <div class="col-span-2 sm:col-span-1">
            <label class="block text-sm font-medium text-gray-700">Encargado</label>
            <div class="mt-1 p-2 border border-gray-300 rounded-md">{documento.idEncargado}</div>
          </div>
        </div>

        <div class="mt-5">
          <button class="bg-blue-500 text-white px-4 py-2 rounded">Editar Documento</button>
        </div>
      </div>
    ) : (
      <p>No se encontró el documento.</p>
    )}
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Recuperar el token desde localStorage en el cliente
    const token = localStorage.getItem('token');
    console.log('Token recuperado desde localStorage:', token); // Verificar el token en el cliente

    if (!token) {
      console.error('No se ha encontrado un token de autenticación');
      return;
    }

    // Establecer el token como una cookie para que pueda ser utilizado en el servidor
    document.cookie = `token=${token}; path=/;`;
    console.log('Token establecido como cookie.'); // Confirmación de que el token se ha guardado como cookie
  });
</script>

<style is:global>
  body {
    background-color: #f9f9f9;
  }
  .block {
    margin-bottom: 0.5rem;
  }
</style>
